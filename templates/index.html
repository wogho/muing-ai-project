<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤í…œ ë¶„ë¦¬ ì„œë¹„ìŠ¤ (ìµœì¢…)</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding-top: 50px; }
        form { border: 1px solid #ccc; padding: 20px; border-radius: 8px; }
        #result-container { margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; min-width: 400px; }
        .result-item { margin-bottom: 10px; }
        .result-item span { font-weight: bold; display: block; margin-bottom: 5px; }
        audio { width: 100%; }
    </style>
</head>
<body>

    <h1>ğŸµ ìŠ¤í…œ ë¶„ë¦¬ ì„œë¹„ìŠ¤</h1>
    
    <form id="analysis-form">
        <label for="audio_file">ë¶„ì„í•  ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”:</label>
        <br><br>
        <input type="file" id="audio_file" name="audio_file" accept=".mp3,.wav,.m4a,audio/*" required>
        <br><br>
        <input type="submit" value="ë¶„ì„ ì‹œì‘">
    </form>

    <div id="status" style="margin-top: 20px;"></div>

    <div id="result-container" style="display:none;">
        <h3>ë¶„ì„ ê²°ê³¼</h3>
        <div id="result-list"></div>
    </div>

    <script>
        // HTML ìš”ì†Œë“¤ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const form = document.getElementById('analysis-form');
        const audioFileInput = document.getElementById('audio_file');
        const statusDiv = document.getElementById('status');
        const resultContainer = document.getElementById('result-container');
        const resultList = document.getElementById('result-list');

        // ìƒíƒœë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ í™•ì¸í•  ë•Œ ì‚¬ìš©í•  ë³€ìˆ˜ì…ë‹ˆë‹¤.
        let statusInterval;

        // 'ë¶„ì„ ì‹œì‘' ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œì˜ ë™ì‘ì…ë‹ˆë‹¤.
        form.addEventListener('submit', function(event) {
            // formì˜ ê¸°ë³¸ ë™ì‘(í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨)ì„ ë§‰ìŠµë‹ˆë‹¤.
            event.preventDefault(); 
            
            const file = audioFileInput.files[0];
            if (!file) {
                statusDiv.textContent = 'âŒ íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.';
                return;
            }

            const formData = new FormData(form);
            statusDiv.textContent = 'âœ… ì£¼ë¬¸ ì ‘ìˆ˜! ì„œë²„ì—ì„œ AI ëª¨ë¸ì„ ì‹¤í–‰í•©ë‹ˆë‹¤... (ì‹œê°„ì´ ê±¸ë¦½ë‹ˆë‹¤)';
            resultContainer.style.display = 'none';
            resultList.innerHTML = '';
            
            // ì´ì „ì— ì‹¤í–‰ë˜ë˜ ìƒíƒœ í™•ì¸ì´ ìˆë‹¤ë©´ ì¤‘ì§€ì‹œí‚µë‹ˆë‹¤.
            if(statusInterval) clearInterval(statusInterval);

            // 1. '/analyze'ë¥¼ í˜¸ì¶œí•˜ì—¬ ë°±ê·¸ë¼ìš´ë“œ ì‘ì—…ì„ ì‹œì‘ì‹œí‚µë‹ˆë‹¤.
            fetch('/analyze', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // ì„œë²„ê°€ "ì²˜ë¦¬ ì¤‘"ì´ë¼ëŠ” ì‘ë‹µê³¼ í•¨ê»˜ ì‘ì—… IDë¥¼ ì£¼ë©´,
                if (data.status === 'processing' && data.task_id) {
                    // 2. 3ì´ˆë§ˆë‹¤ ì‘ì—… ìƒíƒœ í™•ì¸ì„ ì‹œì‘í•©ë‹ˆë‹¤.
                    statusInterval = setInterval(() => {
                        checkTaskStatus(data.task_id);
                    }, 3000);
                } else {
                    statusDiv.textContent = 'âŒ ì„œë²„ì—ì„œ ì‘ì—…ì„ ì‹œì‘í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
                }
            })
            .catch(error => {
                console.error(error);
                statusDiv.textContent = 'âŒ ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            });
        });

        // 3. ì‘ì—… ìƒíƒœë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ í™•ì¸í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.
        function checkTaskStatus(taskId) {
            fetch(`/status/${taskId}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'complete') {
                    // 4. ì‘ì—…ì´ ì™„ë£Œë˜ë©´, ìƒíƒœ í™•ì¸ì„ ì¤‘ì§€í•˜ê³  ê²°ê³¼ë¥¼ í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤.
                    clearInterval(statusInterval);
                    statusDiv.textContent = `âœ… ${data.message}`;
                    
                    if (data.result_files) {
                        resultContainer.style.display = 'block';
                        for (const [stemName, fileUrl] of Object.entries(data.result_files)) {
                            const div = document.createElement('div');
                            div.className = 'result-item';
                            div.innerHTML = `
                                <span>${stemName.toUpperCase()}</span>
                                <audio controls src="${fileUrl}"></audio>
                            `;
                            resultList.appendChild(div);
                        }
                    }
                } else if (data.status === 'error') {
                    // ì‘ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´, ìƒíƒœ í™•ì¸ì„ ì¤‘ì§€í•˜ê³  ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
                    clearInterval(statusInterval);
                    statusDiv.textContent = `âŒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${data.message}`;
                } else {
                    // ì•„ì§ "ì²˜ë¦¬ ì¤‘"ì´ë©´, í™”ë©´ì— ì ì„ ì°ì–´ ì‚´ì•„ìˆìŒì„ í‘œì‹œí•©ë‹ˆë‹¤.
                    statusDiv.textContent += '.';
                }
            })
            .catch(error => {
                // ìƒíƒœ í™•ì¸ ìì²´ì— ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´ ì¤‘ì§€í•©ë‹ˆë‹¤.
                clearInterval(statusInterval);
                console.error('ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
            });
        }
    </script>
</body>
</html>
