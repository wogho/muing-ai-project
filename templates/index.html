<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤í…œ ë¶„ë¦¬ ì„œë¹„ìŠ¤ (ìµœì¢…)</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding-top: 50px; }
        form { border: 1px solid #ccc; padding: 20px; border-radius: 8px; }
        #result-container { margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; min-width: 400px; }
        .result-item { margin-bottom: 10px; }
        .result-item span { font-weight: bold; display: block; margin-bottom: 5px; }
        audio { width: 100%; }
        a { margin-top: 15px; }
    </style>
</head>
<body>

    <h1>ğŸµ ìŠ¤í…œ ë¶„ë¦¬ ì„œë¹„ìŠ¤</h1>
    
    <form id="analysis-form">
        <label for="audio_file">ë¶„ì„í•  ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”:</label>
        <br><br>
        <input type="file" id="audio_file" name="audio_file" accept=".mp3,.wav,.m4a,audio/*" required>
        <br><br>
        <input type="submit" value="ë¶„ì„ ì‹œì‘">
    </form>

    <div id="status" style="margin-top: 20px;"></div>

    <div id="result-container" style="display:none;">
        <h3>ë¶„ì„ ê²°ê³¼</h3>
        <div id="result-list"></div>
    </div>

    <script>
        const form = document.getElementById('analysis-form');
        const audioFileInput = document.getElementById('audio_file');
        const statusDiv = document.getElementById('status');
        const resultContainer = document.getElementById('result-container');
        const resultList = document.getElementById('result-list');

        let statusInterval;

        form.addEventListener('submit', function(event) {
            event.preventDefault(); 
            
            const file = audioFileInput.files[0];
            if (!file) {
                statusDiv.textContent = 'âŒ íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.';
                return;
            }

            const formData = new FormData(form);
            statusDiv.textContent = 'âœ… ì£¼ë¬¸ ì ‘ìˆ˜! ì„œë²„ì—ì„œ AI ëª¨ë¸ì„ ì‹¤í–‰í•©ë‹ˆë‹¤... (ì‹œê°„ì´ ê±¸ë¦½ë‹ˆë‹¤)';
            resultContainer.style.display = 'none';
            resultList.innerHTML = '';
            
            if(statusInterval) clearInterval(statusInterval);

            fetch('/analyze', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'processing' && data.task_id) {
                    statusInterval = setInterval(() => {
                        checkTaskStatus(data.task_id);
                    }, 3000); // 3ì´ˆë§ˆë‹¤ ìƒíƒœ í™•ì¸
                } else {
                    statusDiv.textContent = 'âŒ ì„œë²„ì—ì„œ ì‘ì—…ì„ ì‹œì‘í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
                }
            })
            .catch(error => {
                console.error(error);
                statusDiv.textContent = 'âŒ ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            });
        });

        function checkTaskStatus(taskId) {
            fetch(`/status/${taskId}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'complete') {
                    clearInterval(statusInterval);
                    statusDiv.textContent = `âœ… ${data.message}`;
                    
                    resultContainer.style.display = 'block';
                    resultList.innerHTML = ''; // ì´ì „ ê²°ê³¼ ë¹„ìš°ê¸°

                    // ì˜¤ë””ì˜¤ íŒŒì¼ ê²°ê³¼ í‘œì‹œ
                    if (data.result_files) {
                        for (const [stemName, fileUrl] of Object.entries(data.result_files)) {
                            const div = document.createElement('div');
                            div.className = 'result-item';
                            div.innerHTML = `
                                <span>${stemName.toUpperCase()}</span>
                                <audio controls src="${fileUrl}"></audio>
                            `;
                            resultList.appendChild(div);
                        }
                    }

                    // ìµœì¢… íƒ€ì„ë¼ì¸ JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë§í¬ í‘œì‹œ
                    if (data.timeline_file) {
                        const link = document.createElement('a');
                        link.href = data.timeline_file;
                        link.textContent = 'ê²°ê³¼ íƒ€ì„ë¼ì¸ ë‹¤ìš´ë¡œë“œ (muing_timeline.json)';
                        link.download = 'muing_timeline.json';
                        resultList.appendChild(link);
                    }

                } else if (data.status === 'error') {
                    clearInterval(statusInterval);
                    statusDiv.textContent = `âŒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${data.message}`;
                } else {
                    statusDiv.textContent += '.';
                }
            })
            .catch(error => {
                clearInterval(statusInterval);
                console.error('ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
            });
        }
    </script>
</body>
</html>